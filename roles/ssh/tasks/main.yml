---
# roles/ssh/tasks/main.yml
- name: Ensure .ssh directory exists with correct permissions
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  tags:
    - ssh
    - security

- name: Copy SSH key templates
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ host_user_home }}/.ssh/"
    mode: '0600'
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  with_items:
    - gh_id_ed25519.tpl
  tags:
    - ssh
    - security

- name: Inject GitHub SSH private key
  become_user: "{{ host_user }}"
  ansible.builtin.shell: "op inject -i {{ host_user_home }}/.ssh/gh_id_ed25519.tpl -o {{ host_user_home }}/.ssh/gh_id_ed25519 -f"
  register: inject_gh_private_key
  no_log: true
  tags:
    - ssh
    - security
    - secrets

- name: Ensure correct permissions on SSH files
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh/{{ item.file }}"
    mode: "{{ item.mode }}"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  with_items:
    - { file: 'gh_id_ed25519', mode: '0600' }
  tags:
    - ssh
    - security

- name: Copy SSH config file
  ansible.builtin.copy:
    src: config
    dest: "{{ host_user_home }}/.ssh/config"
    mode: '0600'
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  tags:
    - ssh
    - security

- name: Add GitHub SSH host keys to known_hosts
  ansible.builtin.known_hosts:
    name: github.com
    key: "{{ item }}"
    path: "{{ host_user_home }}/.ssh/known_hosts"
    state: present
  become_user: "{{ host_user }}"
  with_items:
    - "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
    - "github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg="
    - "github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk="
  tags:
    - ssh
    - security

- name: Remove template files
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh/{{ item }}"
    state: absent
  with_items:
    - gh_id_ed25519.tpl
  tags:
    - ssh
    - security
    - cleanup
