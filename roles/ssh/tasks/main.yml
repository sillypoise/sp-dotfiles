---
# roles/ssh/tasks/main.yml
- name: Ensure .ssh directory exists with correct permissions
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  tags:
    - ssh
    - security

- name: Copy SSH key templates
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ host_user_home }}/.ssh/"
    mode: '0600'
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  with_items:
    - gh_id_ed25519.tpl
  tags:
    - ssh
    - security

- name: Warn when OP service account token is missing
  ansible.builtin.debug:
    msg: "OP_SERVICE_ACCOUNT_TOKEN is not set; skipping 1Password SSH secret injection."
  when: facts_op_installed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length == 0)
  tags:
    - ssh
    - security
    - secrets

- name: Inject GitHub SSH private key to temporary file
  become: true
  become_user: "{{ host_user }}"
  ansible.builtin.shell: "op inject -i {{ host_user_home }}/.ssh/gh_id_ed25519.tpl -o {{ host_user_home }}/.ssh/gh_id_ed25519.tmp -f"
  register: inject_gh_private_key
  no_log: true
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"
  when: facts_op_installed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length > 0)
  tags:
    - ssh
    - security
    - secrets

- name: Stat injected SSH key
  ansible.builtin.stat:
    path: "{{ host_user_home }}/.ssh/gh_id_ed25519.tmp"
    checksum_algorithm: sha256
  register: injected_key_stat
  when: inject_gh_private_key is defined and inject_gh_private_key is succeeded
  tags:
    - ssh
    - security
    - secrets

- name: Stat existing SSH key
  ansible.builtin.stat:
    path: "{{ host_user_home }}/.ssh/gh_id_ed25519"
    checksum_algorithm: sha256
  register: existing_key_stat
  when: inject_gh_private_key is defined and inject_gh_private_key is succeeded
  tags:
    - ssh
    - security
    - secrets

- name: Determine if SSH key update is needed
  ansible.builtin.set_fact:
    update_gh_key: >-
      {{ injected_key_stat.stat.exists and
         (not existing_key_stat.stat.exists or injected_key_stat.stat.checksum != existing_key_stat.stat.checksum) }}
  when: inject_gh_private_key is defined and inject_gh_private_key is succeeded
  tags:
    - ssh
    - security
    - secrets

- name: Update GitHub SSH private key when changed
  ansible.builtin.copy:
    src: "{{ host_user_home }}/.ssh/gh_id_ed25519.tmp"
    dest: "{{ host_user_home }}/.ssh/gh_id_ed25519"
    remote_src: true
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: '0600'
  when: update_gh_key | default(false)
  tags:
    - ssh
    - security
    - secrets

- name: Ensure correct permissions on SSH files
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh/{{ item.file }}"
    mode: "{{ item.mode }}"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  with_items:
    - { file: 'gh_id_ed25519', mode: '0600' }
  when: existing_key_stat is defined and existing_key_stat.stat.exists
  tags:
    - ssh
    - security

- name: Remove temporary SSH key
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh/gh_id_ed25519.tmp"
    state: absent
  when: injected_key_stat is defined and injected_key_stat.stat.exists
  tags:
    - ssh
    - security
    - cleanup

- name: Copy SSH config file
  ansible.builtin.copy:
    src: config
    dest: "{{ host_user_home }}/.ssh/config"
    mode: '0600'
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
  tags:
    - ssh
    - security

- name: Add GitHub SSH host keys to known_hosts
  ansible.builtin.known_hosts:
    name: github.com
    key: "{{ item }}"
    path: "{{ host_user_home }}/.ssh/known_hosts"
    state: present
  become_user: "{{ host_user }}"
  become: true
  with_items:
    - "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
    - "github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg="
    - "github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk="
  tags:
    - ssh
    - security

- name: Remove template files
  ansible.builtin.file:
    path: "{{ host_user_home }}/.ssh/{{ item }}"
    state: absent
  with_items:
    - gh_id_ed25519.tpl
  when: inject_gh_private_key is defined and inject_gh_private_key is succeeded
  tags:
    - ssh
    - security
    - cleanup
