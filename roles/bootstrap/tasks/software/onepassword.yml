---
- name: software | one_password | install prerequisites (Ubuntu)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - apt-transport-https
    state: present
    update_cache: true
  when: facts_is_ubuntu
  tags:
    - bootstrap
    - packages

- name: software | one_password | add apt key (Ubuntu)
  ansible.builtin.apt_key:
    url: https://downloads.1password.com/linux/keys/1password.asc
    state: present
  when: facts_is_ubuntu
  tags:
    - bootstrap
    - repositories

- name: software | one_password | add apt repository (Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://downloads.1password.com/linux/debian/amd64 stable main"
    filename: 1password
    state: present
  when: facts_is_ubuntu
  tags:
    - bootstrap
    - repositories

- name: software | one_password | install 1password-cli (Ubuntu)
  ansible.builtin.apt:
    name: 1password-cli
    state: present
    update_cache: true
  when: facts_is_ubuntu
  tags:
    - bootstrap
    - packages

- name: software | one_password | check pacman key (Arch)
  ansible.builtin.command: "pacman-key --list-keys 3FEF9748469ADBE15DA7CA80AC2D62742012EA22"
  register: op_key_check
  changed_when: false
  failed_when: false
  when: facts_is_arch
  tags:
    - bootstrap
    - repositories

- name: software | one_password | import pacman key (Arch)
  ansible.builtin.command: "pacman-key --recv-keys 3FEF9748469ADBE15DA7CA80AC2D62742012EA22"
  when: facts_is_arch and op_key_check.rc != 0
  tags:
    - bootstrap
    - repositories

- name: software | one_password | locally sign pacman key (Arch)
  ansible.builtin.command: "pacman-key --lsign-key 3FEF9748469ADBE15DA7CA80AC2D62742012EA22"
  when: facts_is_arch and op_key_check.rc != 0
  tags:
    - bootstrap
    - repositories

- name: software | one_password | add pacman repository (Arch)
  ansible.builtin.blockinfile:
    path: /etc/pacman.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK onepassword"
    block: |
      [1password]
      Server = https://downloads.1password.com/linux/arch/$repo/$arch
  when: facts_is_arch
  tags:
    - bootstrap
    - repositories

- name: software | one_password | install 1password-cli (Arch)
  ansible.builtin.pacman:
    name: 1password-cli
    state: present
    update_cache: true
  when: facts_is_arch
  tags:
    - bootstrap
    - packages

- name: software | one_password | verify op cli installation
  ansible.builtin.command: op --version
  register: op_version
  changed_when: false
  when: facts_is_arch or facts_is_ubuntu
  tags:
    - bootstrap
    - verification

- name: software | one_password | display op cli version
  ansible.builtin.debug:
    msg: "Installed op version: {{ op_version.stdout }}"
  when: facts_is_arch or facts_is_ubuntu
  tags:
    - bootstrap
    - debug
