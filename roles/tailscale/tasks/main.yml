---
- name: Install Tailscale with pacman (Arch)
  ansible.builtin.pacman:
    name: tailscale
    state: present
  register: tailscale_install
  when: facts_is_arch

- name: Download Tailscale apt key (Ubuntu)
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_facts['distribution_release'] }}.noarmor.gpg"
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: '0644'
  when: facts_is_ubuntu

- name: Add Tailscale apt repository (Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu {{ ansible_facts['distribution_release'] }} main"
    filename: tailscale
    state: present
  when: facts_is_ubuntu

- name: Install Tailscale with apt (Ubuntu)
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  register: tailscale_install
  when: facts_is_ubuntu

- name: Ensure temporary directory for secrets exists
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/secrets"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: '0700'

- name: Copy secrets.tpl to temporary location for user injection
  ansible.builtin.copy:
    src: secrets.tpl  # Path to your .tpl file in Ansible
    dest: "{{ host_user_home }}/.config/secrets/secrets.tpl"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: '0600'

- name: "Inject secrets into temporary environment file as {{ host_user }}"
  become: true
  become_user: "{{ host_user }}"
  ansible.builtin.shell: |
    op inject -i {{ host_user_home }}/.config/secrets/secrets.tpl -o {{ host_user_home }}/.config/secrets/environment.tmp -f
  register: inject_result
  no_log: true
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"
  when: facts_op_installed and facts_zsh_config_installed and not facts_tailscale_authed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length > 0)

- name: Warn when OP service account token is missing
  ansible.builtin.debug:
    msg: "OP_SERVICE_ACCOUNT_TOKEN is not set; skipping Tailscale secret injection."
  when: facts_op_installed and facts_zsh_config_installed and not facts_tailscale_authed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length == 0)

- name: Move environment file to /etc/environment
  ansible.builtin.copy:
    src: "{{ host_user_home }}/.config/secrets/environment.tmp"
    dest: /etc/environment
    remote_src: true
    owner: root
    group: root
    mode: '0600'
  when: facts_zsh_config_installed and not facts_tailscale_authed
  tags:
    - security

- name: Enable and start Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    state: started
    enabled: true
    daemon_reload: true
  become: true
  when: (tailscale_install is defined and tailscale_install is changed) or facts_tailscale_installed | default(false)

- name: Start Tailscale with auth key
  ansible.builtin.command:
    argv:
      - tailscale
      - up
      - "--authkey={{ lookup('env', 'TAILSCALE_AUTHKEY') }}"
      - "--accept-dns=false"
  register: tailscale_up
  changed_when: tailscale_up.rc == 0
  become: true
  environment:
    TAILSCALE_AUTHKEY: "{{ lookup('env', 'TAILSCALE_AUTHKEY') }}"
  no_log: true  # keep the auth key secure
  when: facts_zsh_config_installed and not facts_tailscale_authed and (lookup('env', 'TAILSCALE_AUTHKEY') | length > 0)
