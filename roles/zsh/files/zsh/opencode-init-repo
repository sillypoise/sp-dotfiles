#!/usr/bin/env bash
set -euo pipefail

if ! command -v git >/dev/null 2>&1; then
  echo "git is required for opencode-init-repo" >&2
  exit 1
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "${repo_root}" ]; then
  echo "Run opencode-init-repo inside a git repository" >&2
  exit 1
fi

guides_root="${HOME}/.local/share/opencode-guides"
if [ ! -d "${guides_root}" ]; then
  echo "Missing shared guides repo at ${guides_root}" >&2
  exit 1
fi

template_path="${guides_root}/templates/repo-AGENTS.md"
if [ ! -f "${template_path}" ]; then
  echo "Missing repo overlay template at ${template_path}" >&2
  exit 1
fi

bundle_path="${guides_root}/files/GUIDE_BUNDLE.json"
if [ ! -f "${bundle_path}" ]; then
  echo "Missing guide bundle contract at ${bundle_path}" >&2
  exit 1
fi

target_agents="${repo_root}/AGENTS.md"
if [ -f "${target_agents}" ] && [ -s "${target_agents}" ]; then
  echo "${target_agents} already exists and is not empty" >&2
  exit 1
fi

python3 - "${template_path}" "${bundle_path}" >"${target_agents}" <<'PY'
import json
import pathlib
import sys

template = pathlib.Path(sys.argv[1]).read_text(encoding="utf-8")
bundle = json.loads(pathlib.Path(sys.argv[2]).read_text(encoding="utf-8"))

replacements = {
    "__TEMPLATE_VERSION__": str(bundle["template"]["version"]),
    "__TEMPLATE_SHA256__": str(bundle["template"]["sha256"]),
    "__BUNDLE_VERSION__": str(bundle["version"]),
    "__BUNDLE_SOURCE_REF__": str(bundle["source_ref"]),
}

for token, value in replacements.items():
    template = template.replace(token, value)

sys.stdout.write(template)
PY

config_path="${repo_root}/opencode.json"
cat >"${config_path}" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "instructions": [
    "~/.local/share/opencode-guides/files/AGENTS.md",
    "AGENTS.md"
  ]
}
EOF

echo "Initialized ${target_agents} and ${config_path}"
