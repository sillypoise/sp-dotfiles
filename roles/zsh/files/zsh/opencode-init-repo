#!/usr/bin/env bash
set -euo pipefail

if ! command -v git >/dev/null 2>&1; then
  echo "git is required for opencode-init-repo" >&2
  exit 1
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "${repo_root}" ]; then
  echo "Run opencode-init-repo inside a git repository" >&2
  exit 1
fi

guides_root="${HOME}/.local/share/opencode-guides"
if [ ! -d "${guides_root}" ]; then
  echo "Missing shared guides repo at ${guides_root}" >&2
  exit 1
fi

template_path="${guides_root}/templates/repo-AGENTS.md"
if [ ! -f "${template_path}" ]; then
  echo "Missing repo overlay template at ${template_path}" >&2
  exit 1
fi

target_dir="${repo_root}/.opencode"
target_agents="${target_dir}/AGENTS.md"
if [ -f "${target_agents}" ] && [ -s "${target_agents}" ]; then
  echo "${target_agents} already exists and is not empty" >&2
  exit 1
fi

mkdir -p "${target_dir}"

cp "${template_path}" "${target_agents}"

cat >"${target_dir}/.gitignore" <<'EOF'
credentials/
*.env
EOF

config_path="${repo_root}/opencode.json"
cat >"${config_path}" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "instructions": [
    "{file:~/.local/share/opencode-guides/files/AGENTS.md}",
    "{file:.opencode/AGENTS.md}"
  ]
}
EOF

echo "Initialized ${target_agents} and ${config_path}"
