---
# roles/opencode/tasks/main.yml
- name: Ensure opencode config directory exists
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/opencode"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0755"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Ensure local shared directory exists for OpenCode guides
  ansible.builtin.file:
    path: "{{ host_user_home }}/.local/share"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0755"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Check installed OpenCode version
  ansible.builtin.command:
    cmd: "{{ host_user_home }}/.opencode/bin/opencode --version"
  become: true
  become_user: "{{ host_user }}"
  register: opencode_version
  changed_when: false
  failed_when: false
  tags:
    - opencode
    - install

- name: Fetch OpenCode latest release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/anomalyco/opencode/releases/latest
    return_content: true
  register: opencode_release
  changed_when: false
  failed_when: false
  tags:
    - opencode
    - install

- name: Set OpenCode version facts
  ansible.builtin.set_fact:
    opencode_latest_version: "{{ ((opencode_release.json | default({})).tag_name | default('')) | regex_replace('^v', '') }}"
    opencode_installed_version: "{{ (opencode_version.stdout | default('')) | regex_search('[0-9]+(\\.[0-9]+)+') | default('') }}"
  tags:
    - opencode
    - install

- name: Warn when OpenCode latest version is unavailable
  ansible.builtin.debug:
    msg: "Unable to determine latest OpenCode version; skipping update check."
  when: opencode_latest_version | length == 0
  tags:
    - opencode
    - install

- name: Install or update OpenCode
  ansible.builtin.shell: |
    set -euo pipefail
    if command -v curl >/dev/null 2>&1; then
      curl -fsSL https://opencode.ai/install | bash -s -- --version {{ opencode_latest_version }}
    elif command -v wget >/dev/null 2>&1; then
      wget -qO- https://opencode.ai/install | bash -s -- --version {{ opencode_latest_version }}
    else
      echo "Missing curl or wget" >&2
      exit 1
    fi
  become: true
  become_user: "{{ host_user }}"
  args:
    executable: /bin/bash
  when: opencode_latest_version | length > 0 and (opencode_version.rc != 0 or opencode_installed_version != opencode_latest_version)
  tags:
    - opencode
    - install

- name: Clone OpenCode guides repo with GitHub CLI
  ansible.builtin.command:
    cmd: "gh repo clone {{ opencode_guides_repo }} {{ opencode_guides_clone_path }}"
  become: true
  become_user: "{{ host_user }}"
  when: facts_gh_authed
  changed_when: not ansible_check_mode
  args:
    creates: "{{ opencode_guides_clone_path }}/.git"
  tags:
    - opencode
    - config

- name: Clone OpenCode guides repo with git (fallback)
  ansible.builtin.git:
    repo: "git@github.com:{{ opencode_guides_repo }}.git"
    dest: "{{ opencode_guides_clone_path }}"
    version: "{{ opencode_guides_ref }}"
    force: no
  become: true
  become_user: "{{ host_user }}"
  when: not facts_gh_authed
  tags:
    - opencode
    - config

- name: Check OpenCode guides repository checkout
  ansible.builtin.stat:
    path: "{{ opencode_guides_clone_path }}/.git"
  become: true
  become_user: "{{ host_user }}"
  register: opencode_guides_checkout
  tags:
    - opencode
    - config

- name: Update OpenCode guides checkout to requested ref
  ansible.builtin.shell: |
    set -euo pipefail
    before="$(git -C "{{ opencode_guides_clone_path }}" rev-parse HEAD 2>/dev/null || true)"
    git -C "{{ opencode_guides_clone_path }}" fetch --tags --prune origin
    if git -C "{{ opencode_guides_clone_path }}" rev-parse --verify --quiet "refs/tags/{{ opencode_guides_ref }}" >/dev/null; then
      git -C "{{ opencode_guides_clone_path }}" checkout --force "tags/{{ opencode_guides_ref }}"
    else
      git -C "{{ opencode_guides_clone_path }}" checkout "{{ opencode_guides_ref }}"
      git -C "{{ opencode_guides_clone_path }}" pull --ff-only origin "{{ opencode_guides_ref }}"
    fi
    after="$(git -C "{{ opencode_guides_clone_path }}" rev-parse HEAD)"
    if [ "${before}" != "${after}" ]; then
      echo changed
    fi
  become: true
  become_user: "{{ host_user }}"
  args:
    executable: /bin/bash
  register: opencode_guides_update
  changed_when: "'changed' in opencode_guides_update.stdout"
  when: opencode_guides_checkout.stat.exists
  tags:
    - opencode
    - config

- name: Validate OpenCode guides checkout
  ansible.builtin.command:
    cmd: "{{ opencode_guides_clone_path }}/bin/validate-opencode-guides"
  become: true
  become_user: "{{ host_user }}"
  changed_when: false
  when: opencode_guides_checkout.stat.exists
  tags:
    - opencode
    - config

- name: Write OpenCode global instructions config
  ansible.builtin.copy:
    content: |
      {
        "$schema": "https://opencode.ai/config.json",
        "instructions": ["{{ opencode_guides_clone_path }}/files/AGENTS.md"],
        "permission": {
          "external_directory": {
            "~/.local/share/opencode-guides/**": "allow"
          },
          "read": {
            "~/.local/share/opencode-guides/**": "allow"
          }
        },
        "agent": {
          "build": {
            "model": "openai/gpt-5.3-codex",
            "variant": "medium"
          },
          "plan": {
            "model": "openai/gpt-5.3-codex",
            "variant": "high"
          }
        }
      }
    dest: "{{ host_user_home }}/.config/opencode/opencode.json"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0644"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Write OpenCode TUI config
  ansible.builtin.copy:
    src: "opencode-tui.json"
    dest: "{{ host_user_home }}/.config/opencode/tui.json"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0644"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Ensure opencode credentials directory exists
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/opencode/credentials"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0700"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config
    - secrets


- name: Warn when OP service account token is missing for opencode
  ansible.builtin.debug:
    msg: "OP_SERVICE_ACCOUNT_TOKEN is not set; skipping OpenCode server password injection."
  when: facts_op_installed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length == 0)
  tags:
    - opencode
    - secrets
    - op

- name: Read OpenCode server password from 1Password
  ansible.builtin.command:
    cmd: "/usr/bin/op read op://sp-dev/opencode_server/password"
  register: opencode_secret_read
  no_log: true
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"
  when: facts_op_installed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length > 0)
  tags:
    - opencode
    - secrets
    - op
  changed_when: false

- name: Write OpenCode server password credential
  ansible.builtin.copy:
    content: "{{ opencode_secret_read.stdout }}"
    dest: "{{ host_user_home }}/.config/opencode/credentials/server_password"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0600"
  no_log: true
  when: opencode_secret_read is defined
  tags:
    - opencode
    - secrets

- name: Install OpenCode serve wrapper script
  ansible.builtin.template:
    src: opencode-serve.sh.j2
    dest: /usr/local/bin/opencode-serve
    owner: root
    group: root
    mode: "0755"
  become: true
  tags:
    - opencode
    - system

- name: Install OpenCode serve systemd unit
  ansible.builtin.template:
    src: opencode-serve.service.j2
    dest: /etc/systemd/system/opencode-serve.service
    owner: root
    group: root
    mode: "0644"
  become: true
  tags:
    - opencode
    - system

- name: Reload systemd daemon for OpenCode
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  tags:
    - opencode
    - system

- name: Enable and start OpenCode serve service
  ansible.builtin.systemd:
    name: opencode-serve
    state: started
    enabled: true
  become: true
  tags:
    - opencode
    - system
