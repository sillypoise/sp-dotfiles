---
# roles/opencode/tasks/main.yml
- name: Ensure opencode config directory exists
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/opencode"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0755"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Install or update OpenCode
  ansible.builtin.shell: |
    set -euo pipefail
    if command -v curl >/dev/null 2>&1; then
      curl -fsSL https://opencode.ai/install | bash
    elif command -v wget >/dev/null 2>&1; then
      wget -qO- https://opencode.ai/install | bash
    else
      echo "Missing curl or wget" >&2
      exit 1
    fi
  become: true
  become_user: "{{ host_user }}"
  args:
    executable: /bin/bash
  tags:
    - opencode
    - install

- name: Install opencode guide bundle
  ansible.builtin.copy:
    src: "."
    dest: "{{ host_user_home }}/.config/opencode/"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0644"
    directory_mode: "0755"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config
