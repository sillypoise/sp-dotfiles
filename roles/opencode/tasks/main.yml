---
# roles/opencode/tasks/main.yml
- name: Ensure opencode config directory exists
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/opencode"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0755"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Install or update OpenCode
  ansible.builtin.shell: |
    set -euo pipefail
    if command -v curl >/dev/null 2>&1; then
      curl -fsSL https://opencode.ai/install | bash
    elif command -v wget >/dev/null 2>&1; then
      wget -qO- https://opencode.ai/install | bash
    else
      echo "Missing curl or wget" >&2
      exit 1
    fi
  become: true
  become_user: "{{ host_user }}"
  args:
    executable: /bin/bash
  tags:
    - opencode
    - install

- name: Install opencode guide bundle
  ansible.builtin.copy:
    src: "."
    dest: "{{ host_user_home }}/.config/opencode/"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0644"
    directory_mode: "0755"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config

- name: Ensure opencode credentials directory exists
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/opencode/credentials"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0700"
  become: true
  become_user: "{{ host_user }}"
  tags:
    - opencode
    - config
    - secrets


- name: Warn when OP service account token is missing for opencode
  ansible.builtin.debug:
    msg: "OP_SERVICE_ACCOUNT_TOKEN is not set; skipping OpenCode server password injection."
  when: facts_op_installed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length == 0)
  tags:
    - opencode
    - secrets
    - op

- name: Read OpenCode server password from 1Password
  ansible.builtin.command:
    cmd: "/usr/bin/op read op://sp-dev/opencode_server/password"
  register: opencode_secret_read
  no_log: true
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"
  when: facts_op_installed and (lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length > 0)
  tags:
    - opencode
    - secrets
    - op
  changed_when: false

- name: Write OpenCode server password credential
  ansible.builtin.copy:
    content: "{{ opencode_secret_read.stdout }}"
    dest: "{{ host_user_home }}/.config/opencode/credentials/server_password"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0600"
  no_log: true
  when: opencode_secret_read is defined
  tags:
    - opencode
    - secrets

- name: Install OpenCode serve wrapper script
  ansible.builtin.template:
    src: opencode-serve.sh.j2
    dest: /usr/local/bin/opencode-serve
    owner: root
    group: root
    mode: "0755"
  become: true
  tags:
    - opencode
    - system

- name: Install OpenCode serve systemd unit
  ansible.builtin.template:
    src: opencode-serve.service.j2
    dest: /etc/systemd/system/opencode-serve.service
    owner: root
    group: root
    mode: "0644"
  become: true
  tags:
    - opencode
    - system

- name: Reload systemd daemon for OpenCode
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  tags:
    - opencode
    - system

- name: Enable and start OpenCode serve service
  ansible.builtin.systemd:
    name: opencode-serve
    state: started
    enabled: true
  become: true
  tags:
    - opencode
    - system
