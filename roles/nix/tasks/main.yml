---
- name: Debug | Show current Ansible user
  ansible.builtin.debug:
    msg: "Ansible is using the user: {{ ansible_user }}"
  tags:
    - always

- name: Download Nix installer script
  ansible.builtin.get_url:
    url: https://nixos.org/nix/install
    dest: /tmp/nix-install.sh
    mode: "0755"
  when: not facts_nix_installed
  tags:
    - nix
    - bootstrap
    - system
    - setup

- name: Install Nix package manager in multi-user mode
  ansible.builtin.command:
    cmd: sh /tmp/nix-install.sh --daemon
  args:
    creates: /nix/var/nix/profiles/default
  when: not facts_nix_installed
  tags:
    - nix
    - bootstrap
    - system
    - setup

- name: system setup | nix | enable flakes
  ansible.builtin.lineinfile:
    path: /etc/nix/nix.conf
    line: "experimental-features = nix-command flakes"
    create: true
    mode: "0644"
  tags:
    - nix
    - system
    - config

- name: system setup | nix | set nix system
  ansible.builtin.set_fact:
    nix_system: "{{ 'aarch64-linux' if ansible_architecture in ['aarch64', 'arm64'] else 'x86_64-linux' }}"
  tags:
    - nix
    - system

- name: system setup | nix | verify nix installation
  ansible.builtin.command: /nix/var/nix/profiles/default/bin/nix --version
  register: nix_version
  changed_when: false
  tags:
    - nix
    - verification

- name: system setup | nix | create .config/home-manager directory
  ansible.builtin.file:
    path: "{{ host_user_home }}/.config/home-manager"
    state: directory
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0755"
  tags:
    - nix
    - home-manager

- name: system setup | nix | copy home-manager flake
  ansible.builtin.template:
    src: flake.nix.j2
    dest: "{{ host_user_home }}/.config/home-manager/flake.nix"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0644"
  tags:
    - nix
    - home-manager

- name: system setup | nix | copy home-manager configuration file
  ansible.builtin.copy:
    src: "{{ host_user }}/home.nix"
    dest: "{{ host_user_home }}/.config/home-manager/home.nix"
    owner: "{{ host_user }}"
    group: "{{ host_user }}"
    mode: "0644"
  tags:
    - nix
    - home-manager
    - packages

- name: system setup | nix | generate flake lock
  become_user: "{{ host_user }}"
  ansible.builtin.shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix flake lock {{ host_user_home }}/.config/home-manager
  args:
    executable: /bin/bash
    creates: "{{ host_user_home }}/.config/home-manager/flake.lock"
  when: facts_bash_config_installed or facts_zsh_config_installed
  tags:
    - nix
    - home-manager

- name: system setup | nix | apply home-manager config (flake)
  become_user: "{{ host_user }}"
  ansible.builtin.shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix run home-manager/release-24.05 -- switch --flake {{ host_user_home }}/.config/home-manager
  args:
    executable: /bin/bash
  when: facts_bash_config_installed or facts_zsh_config_installed
  register: hm_result
  changed_when: "'Activating installPackages' in hm_result.stdout"
  tags:
    - nix
    - home-manager
    - packages
